# 0x00 前言

无线网络主要是WIFI和移动运营商网络，通常情况下使用移动网络要比WIFI耗电要多一些。

# 0x01 无线状态机

### 移动网络

移动网络数据传输有3种状态：

<!-- more -->

**Full power**：高功率状态，网络激活，允许设备以最大传输速率进行传输。

**Low power**：低功率状态，传输速率低于15kbps，耗电是Full Power状态的一半，一般不能直接从程序中进入该

状态，而是由Full Power状态降级进入。

**Standby**：空闲状态，没有数据连接需要传输，耗电最少。

这三种状态有一个转换流程：

![mobile_radio_state_machine.png](https://jenson-1258324340.cos.ap-beijing.myqcloud.com/mobile_radio_state_machine.png)



> 可以看出，三种状态耗电不同，要使耗电最低应该尽量保持状态在空闲或低功率下。
>
> 从空闲状态转换到高功率状态需要2s，从低功率状态转换到高功率状态需要1.5s。
>
> 应用中每创建一个网络连接，网络射频都会转到高功率状态，数据传输完毕降回低功率状态，
>
> 降回过程需要5s，这5s耗电量保持在高功率状态，低功率降回到空闲状态需要12s，
>
> 期间一直保持低功率状态。所以每次的数据传输都将导致将近20s电量的消耗。

### WIFI网络

WIFI在active状态下有4种模式：低功率、高功率、低传输、高传输。

当从低(高)功率状态传输数据时，WIFI会暂时进入相应地低(高)传输状态，一旦数据传输完毕就回到初始状态。

> WIFI耗电是受包率(每秒接收和发送的数据包)和网速因素影响的。
>
> 如果因素良好，即网络良好时，数据传输的很快，所以WIFI的高功率状态维持时间很短。
>
> 这也就是说移动网络耗电高于WIFI耗电，因为同样的数据大小传输时，
>
> 移动网络固定状态转换就需要近20s的电量消耗。



通过上面了解网络连接过程，应该心里有了大概的优化建议。

# 0x02 网络优化方案：

优化从**减少请求大小**和**减少请求次数**两方面着手。

### 压缩文本文件

不管发送还是请求数据，在数据传输过程中使用gzip将数据进行压缩。经过压缩的数据需要更短的时间传输即可完成，这样是无线所处的高功率状态时间更短，从而减少了耗电。

### 精简文本文件

精简是另外一个缩小文本文件的方式。精简过程就是去掉文本文件中所有只具有方便阅读

作用的格式（比如空格、制表符和注释），进而使文件变小。   

```html
<html>  
  <title> A Sample Page</title> 
  <body> 
 	 with some sample text 
		<--do more here--> 
	</body> 
</html>
```

精简后

```html
<html><title> A Sample Page</title><body> with some sample text 			<--do more here--></body></html>
```

### 图片

#### 根据显示大小从服务器获取图片

请求一个图片时，客户端提供一个分辨率大小，服务器根据分辨率把裁剪缩放后的图片给客户端返回。

也可以使用Android端使用Bitmap.Option自行获取缩放的图片。

#### 压缩图片

图片适用的有损压缩率取决于图片的用途。 对缩略图而言，压缩率可以更高，

因为它们本身就很小，很难发现有粒子或像素变化。  可以采用webp格式

#### 去掉图片元数据

当用数码相机拍照片时， 文件里很可能有与照片相关的元数据（包括设备名称、设备设置

以及拍摄地点等信息）。

照片编辑软件也会给图片增加一些元数据。

 除非 App 是讨论照片拍摄方法和编辑技巧的摄影 App， 

否则你可以去掉照片上所有相关的元数据，将这些几字节到几十千字节不等的元数据保存在其他地方，

这样不会损坏发送给用户的图片的质量。  

### 文件缓存。

把经常使用的文件缓存到本地，如头像icon、好友信息等。以后可以直接从本地读取缓存减少网络请求次数。

### 分组连接

移动网络下最好批量执行网络请求，利用一次高功率状态执行尽可能多的事情，

从而减少频繁间隔请求导致状态转换消耗更多电量。

例如版本检查和日志上传这些可以分配在同一时间段请求。

再比如获取数据时，一次获取多页数据。

### 网络判断

根据不同的网络状态执行不同的逻辑。

如果在移动网络状态下推迟非紧急请求，在连接到wifi时执行请求。

在WiFi和移动网络不同状态时执行同一套逻辑的不同数据量请求。